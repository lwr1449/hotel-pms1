<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>财务报表 - 酒店管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .sidebar {
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
        }
        
        .tab-button {
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* 加载状态样式 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .loading-spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 侧边导航 -->
    <div class="sidebar fixed left-0 top-0 w-64 h-full bg-white shadow-lg z-40" id="sidebar">
        <div class="p-6 border-b">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">酒店管理系统</h1>
                    <p class="text-xs text-gray-500">PMS v1.0</p>
                </div>
            </div>
        </div>
        
        <nav class="p-4 space-y-2">
            <a href="index.html" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                </svg>
                <span>主控制台</span>
            </a>
            <a href="checkin.html" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                </svg>
                <span>入住登记</span>
            </a>
            <a href="rooms.html" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <span>房态管理</span>
            </a>
            <a href="guests.html" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span>客人管理</span>
            </a>
            <a href="reports.html" class="flex items-center space-x-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span>财务报表</span>
            </a>
        </nav>
        
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
            <div class="text-xs text-gray-500 text-center">
                <p id="currentTime"></p>
                <p class="mt-1">共98间房</p>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="ml-64 min-h-screen" id="mainContent">
        <!-- 顶部导航 -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button class="md:hidden p-2 hover:bg-gray-100 rounded-lg" onclick="toggleSidebar()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-gray-900">财务报表</h2>
                </div>
                
                <div class="flex items-center space-x-3">
                    <select id="reportPeriod" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="changeReportPeriod()">
                        <option value="today">今日</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                        <option value="year">本年</option>
                    </select>
                    <button onclick="exportReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span>导出报表</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="p-6">
            <!-- 收入统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">房费收入</p>
                            <p class="text-3xl font-bold text-green-600" id="roomRevenue">¥0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">押金总额</p>
                            <p class="text-3xl font-bold text-blue-600" id="depositTotal">¥0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">入住订单</p>
                            <p class="text-3xl font-bold text-purple-600" id="totalOrders">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">平均房价</p>
                            <p class="text-3xl font-bold text-orange-600" id="avgRoomRate">¥0</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">收入趋势</h3>
                    <div id="revenueChart" style="height: 300px;">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>加载收入趋势数据中...</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">房型收入分布</h3>
                    <div id="roomTypeRevenueChart" style="height: 300px;">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>加载房型收入数据中...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 详细数据表格 -->
            <div class="bg-white rounded-xl shadow-sm">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">详细收入记录</h3>
                </div>
                
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房间号</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房型</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客人</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房费</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">押金</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总计</th>
                                </tr>
                            </thead>
                            <tbody id="revenueTable" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                        <div class="loading">
                                            <div class="loading-spinner"></div>
                                            <span>加载详细收入记录中...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-sm text-gray-700">
                            显示 <span id="tableStart">1</span>-<span id="tableEnd">10</span> 条，共 <span id="tableTotal">0</span> 条记录
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="previousPage()" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" id="prevBtn" disabled>上一页</button>
                            <button onclick="nextPage()" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50" id="nextBtn" disabled>下一页</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================== 全局配置 =====================
        // LeanCloud 初始化（替换为你的实际配置）
        AV.init({
            appId: "YOUR_LEANCLOUD_APP_ID",
            appKey: "YOUR_LEANCLOUD_APP_KEY",
            serverURL: "https://your-server-url.api.lncldglobal.com"
        });

        // 全局变量
        let currentPeriod = 'today';
        let currentPage = 1;
        const pageSize = 10;
        let allRevenueRecords = []; // 存储所有收入记录
        let revenueChartInstance = null; // 收入趋势图表实例
        let roomTypeChartInstance = null; // 房型收入图表实例

        // ===================== 页面初始化 =====================
        document.addEventListener('DOMContentLoaded', async function() {
            // 初始化实时时间显示
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 初始化图表实例
            initCharts();
            
            // 加载报表数据
            await initializeReportsPage();
            
            // 响应窗口大小变化，自适应图表
            window.addEventListener('resize', function() {
                if (revenueChartInstance) revenueChartInstance.resize();
                if (roomTypeChartInstance) roomTypeChartInstance.resize();
            });
        });

        // ===================== 核心功能函数 =====================
        /**
         * 初始化报表页面，加载所有数据
         */
        async function initializeReportsPage() {
            try {
                // 并行加载各类数据，提升性能
                await Promise.all([
                    loadFinancialData(),
                    loadRevenueChart(),
                    loadRoomTypeRevenueChart(),
                    loadRevenueTable()
                ]);
            } catch (error) {
                console.error('初始化报表页面失败:', error);
                showErrorNotification('数据加载失败，请刷新页面重试');
            }
        }

        /**
         * 加载核心财务数据（总收入、押金、订单数、平均房价）
         */
        async function loadFinancialData() {
            try {
                const data = await getFinancialData(currentPeriod);
                
                // 格式化数字显示（千分位分隔）
                document.getElementById('roomRevenue').textContent = `¥${formatNumber(data.roomRevenue)}`;
                document.getElementById('depositTotal').textContent = `¥${formatNumber(data.depositTotal)}`;
                document.getElementById('totalOrders').textContent = data.totalOrders;
                document.getElementById('avgRoomRate').textContent = `¥${formatNumber(data.avgRoomRate, 0)}`;
            } catch (error) {
                console.error('加载财务数据失败:', error);
                // 显示默认值，避免页面空白
                document.getElementById('roomRevenue').textContent = '¥0';
                document.getElementById('depositTotal').textContent = '¥0';
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('avgRoomRate').textContent = '¥0';
            }
        }

        /**
         * 加载收入趋势图表
         */
        async function loadRevenueChart() {
            try {
                const data = await getRevenueTrendData(currentPeriod);
                
                // 图表配置
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#333'
                            }
                        },
                        formatter: '{b}<br/>收入: ¥{c}'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: data.dates,
                        axisLine: {
                            lineStyle: {
                                color: '#e5e7eb'
                            }
                        },
                        axisLabel: {
                            color: '#6b7280',
                            fontSize: 12
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: {
                            lineStyle: {
                                color: '#e5e7eb'
                            }
                        },
                        axisLabel: {
                            color: '#6b7280',
                            fontSize: 12,
                            formatter: '¥{value}'
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#f3f4f6'
                            }
                        }
                    },
                    series: [{
                        name: '日收入',
                        data: data.revenues,
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            color: '#3b82f6',
                            width: 3
                        },
                        itemStyle: {
                            color: '#3b82f6'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(59, 130, 246, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(59, 130, 246, 0.05)'
                                }]
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(59, 130, 246, 0.5)'
                            }
                        }
                    }]
                };
                
                revenueChartInstance.setOption(option);
            } catch (error) {
                console.error('加载收入趋势图表失败:', error);
                document.getElementById('revenueChart').innerHTML = 
                    '<div class="text-center py-8 text-red-500">加载图表失败，请重试</div>';
            }
        }

        /**
         * 加载房型收入分布图表
         */
        async function loadRoomTypeRevenueChart() {
            try {
                const data = await getRoomTypeRevenueData(currentPeriod);
                
                // 自定义饼图颜色
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                
                const option = {
                    color: colors,
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: ¥{c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        textStyle: {
                            color: '#6b7280',
                            fontSize: 12
                        }
                    },
                    series: [{
                        name: '房型收入',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '50%'],
                        data: data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        itemStyle: {
                            borderRadius: 8,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            fontSize: 12,
                            formatter: '{b}: {d}%'
                        }
                    }]
                };
                
                roomTypeChartInstance.setOption(option);
            } catch (error) {
                console.error('加载房型收入图表失败:', error);
                document.getElementById('roomTypeRevenueChart').innerHTML = 
                    '<div class="text-center py-8 text-red-500">加载图表失败，请重试</div>';
            }
        }

        /**
         * 加载收入明细表格
         */
        async function loadRevenueTable() {
            try {
                // 获取所有收入记录
                allRevenueRecords = await getRevenueRecords(currentPeriod);
                
                // 计算分页
                const totalRecords = allRevenueRecords.length;
                const totalPages = Math.ceil(totalRecords / pageSize);
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, totalRecords);
                const pageData = allRevenueRecords.slice(startIndex, endIndex);
                
                const tbody = document.getElementById('revenueTable');
                tbody.innerHTML = '';
                
                // 无数据时显示提示
                if (totalRecords === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                暂无收入记录
                            </td>
                        </tr>
                    `;
                } else {
                    // 渲染表格数据
                    pageData.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${formatDate(record.date)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${record.roomNumber || '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${record.roomType || '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${record.guestName || '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ¥${formatNumber(record.roomRate)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ¥${formatNumber(record.deposit)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ¥${formatNumber(record.total)}
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                // 更新分页信息
                document.getElementById('tableStart').textContent = totalRecords > 0 ? startIndex + 1 : 0;
                document.getElementById('tableEnd').textContent = Math.min(endIndex, totalRecords);
                document.getElementById('tableTotal').textContent = totalRecords;
                
                // 更新分页按钮状态
                document.getElementById('prevBtn').disabled = currentPage === 1 || totalRecords === 0;
                document.getElementById('nextBtn').disabled = currentPage >= totalPages || totalRecords === 0;
                
            } catch (error) {
                console.error('加载收入表格失败:', error);
                document.getElementById('revenueTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-red-500">
                            加载数据失败，请重试
                        </td>
                    </tr>
                `;
            }
        }

        /**
         * 切换报表周期
         */
        async function changeReportPeriod() {
            currentPeriod = document.getElementById('reportPeriod').value;
            currentPage = 1; // 重置到第一页
            
            // 显示加载状态
            showLoadingState();
            
            try {
                await initializeReportsPage();
            } catch (error) {
                console.error('切换报表周期失败:', error);
                showErrorNotification('切换报表周期失败，请重试');
            }
        }

        /**
         * 上一页
         */
        async function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                await loadRevenueTable();
            }
        }

        /**
         * 下一页
         */
        async function nextPage() {
            const totalPages = Math.ceil(allRevenueRecords.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                await loadRevenueTable();
            }
        }

        /**
         * 导出报表为CSV文件
         */
        async function exportReport() {
            try {
                // 显示加载提示
                const originalText = document.querySelector('button[onclick="exportReport()"] span').textContent;
                document.querySelector('button[onclick="exportReport()"] span').textContent = '导出中...';
                
                // 获取完整数据
                const data = await getRevenueRecords(currentPeriod);
                
                if (data.length === 0) {
                    alert('当前周期暂无数据可导出');
                    document.querySelector('button[onclick="exportReport()"] span').textContent = originalText;
                    return;
                }
                
                // 构建CSV内容（处理中文编码）
                let csvContent = "\uFEFF"; // BOM头，解决Excel中文乱码
                csvContent += "日期,房间号,房型,客人姓名,房费,押金,总计\n";
                
                data.forEach(record => {
                    const row = [
                        formatDate(record.date),
                        record.roomNumber || '',
                        record.roomType || '',
                        record.guestName || '',
                        record.roomRate || 0,
                        record.deposit || 0,
                        record.total || 0
                    ].map(field => {
                        // 处理包含逗号的字段，用双引号包裹
                        return `"${String(field).replace(/"/g, '""')}"`;
                    }).join(',');
                    
                    csvContent += row + "\n";
                });
                
                // 创建并下载文件
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // 生成文件名
                const periodNames = {
                    today: '今日',
                    week: '本周',
                    month: '本月',
                    year: '本年'
                };
                const fileName = `财务报表_${periodNames[currentPeriod]}_${formatDate(new Date(), 'YYYYMMDD')}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 恢复按钮文本
                document.querySelector('button[onclick="exportReport()"] span').textContent = originalText;
                showSuccessNotification('报表导出成功');
                
            } catch (error) {
                console.error('导出报表失败:', error);
                // 恢复按钮文本
                document.querySelector('button[onclick="exportReport()"] span').textContent = '导出报表';
                showErrorNotification('导出报表失败：' + error.message);
            }
        }

        // ===================== 数据获取函数（LeanCloud交互） =====================
        /**
         * 获取核心财务数据
         * @param {string} period 时间周期: today/week/month/year
         * @returns {Object} 财务汇总数据
         */
        async function getFinancialData(period) {
            // 构建时间查询条件
            const { startDate, endDate } = getDateRange(period);
            
            // 查询订单/客人数据
            const Guest = AV.Object.extend('Guest');
            const query = new AV.Query(Guest);
            query.greaterThanOrEqualTo('checkinTime', startDate);
            query.lessThanOrEqualTo('checkinTime', endDate);
            query.equalTo('status', 'checkin'); // 只查已入住的订单
            
            const results = await query.find();
            
            // 计算汇总数据
            let roomRevenue = 0;
            let depositTotal = 0;
            let totalOrders = results.length;
            
            results.forEach(guest => {
                const roomRate = guest.get('roomRate') || 0;
                const deposit = guest.get('deposit') || 0;
                
                roomRevenue += roomRate;
                depositTotal += deposit;
            });
            
            // 计算平均房价
            const avgRoomRate = totalOrders > 0 ? (roomRevenue / totalOrders).toFixed(0) : 0;
            
            return {
                roomRevenue: Math.round(roomRevenue),
                depositTotal: Math.round(depositTotal),
                totalOrders,
                avgRoomRate
            };
        }

        /**
         * 获取收入趋势数据
         * @param {string} period 时间周期
         * @returns {Object} 包含dates和revenues的趋势数据
         */
        async function getRevenueTrendData(period) {
            const { startDate, endDate } = getDateRange(period);
            const dates = [];
            const revenues = [];
            
            // 根据不同周期生成日期数组
            if (period === 'today') {
                // 今日按小时统计（简化为按天）
                dates.push(formatDate(new Date()));
                const financialData = await getFinancialData('today');
                revenues.push(financialData.roomRevenue);
                
            } else if (period === 'week') {
                // 本周按天统计
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    if (date > endDate) break;
                    
                    dates.push(formatDate(date, 'MM-DD'));
                    
                    // 查询当天数据
                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const Guest = AV.Object.extend('Guest');
                    const query = new AV.Query(Guest);
                    query.greaterThanOrEqualTo('checkinTime', dayStart);
                    query.lessThanOrEqualTo('checkinTime', dayEnd);
                    query.equalTo('status', 'checkin');
                    
                    const results = await query.find();
                    const revenue = results.reduce((sum, guest) => sum + (guest.get('roomRate') || 0), 0);
                    revenues.push(Math.round(revenue));
                }
                
            } else if (period === 'month') {
                // 本月按天统计（取最近15天）
                const daysInMonth = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
                const startDay = Math.max(1, daysInMonth - 14);
                
                for (let day = startDay; day <= daysInMonth; day++) {
                    const date = new Date(endDate.getFullYear(), endDate.getMonth(), day);
                    dates.push(formatDate(date, 'MM-DD'));
                    
                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const Guest = AV.Object.extend('Guest');
                    const query = new AV.Query(Guest);
                    query.greaterThanOrEqualTo('checkinTime', dayStart);
                    query.lessThanOrEqualTo('checkinTime', dayEnd);
                    query.equalTo('status', 'checkin');
                    
                    const results = await query.find();
                    const revenue = results.reduce((sum, guest) => sum + (guest.get('roomRate') || 0), 0);
                    revenues.push(Math.round(revenue));
                }
                
            } else if (period === 'year') {
                // 本年按月统计
                for (let month = 0; month < 12; month++) {
                    const date = new Date(endDate.getFullYear(), month, 1);
                    if (date > endDate) break;
                    
                    dates.push(formatDate(date, 'MM月'));
                    
                    const monthStart = new Date(date.getFullYear(), month, 1);
                    const monthEnd = new Date(date.getFullYear(), month + 1, 0, 23, 59, 59, 999);
                    
                    const Guest = AV.Object.extend('Guest');
                    const query = new AV.Query(Guest);
                    query.greaterThanOrEqualTo('checkinTime', monthStart);
                    query.lessThanOrEqualTo('checkinTime', monthEnd);
                    query.equalTo('status', 'checkin');
                    
                    const results = await query.find();
                    const revenue = results.reduce((sum, guest) => sum + (guest.get('roomRate') || 0), 0);
                    revenues.push(Math.round(revenue));
                }
            }
            
            return { dates, revenues };
        }

        /**
         * 获取房型收入分布数据
         * @param {string} period 时间周期
         * @returns {Array} 房型收入数据
         */
        async function getRoomTypeRevenueData(period) {
            const { startDate, endDate } = getDateRange(period);
            
            // 查询订单数据
            const Guest = AV.Object.extend('Guest');
            const query = new AV.Query(Guest);
            query.greaterThanOrEqualTo('checkinTime', startDate);
            query.lessThanOrEqualTo('checkinTime', endDate);
            query.equalTo('status', 'checkin');
            const guests = await query.find();
            
            // 按房型分组统计收入
            const roomTypeRevenue = {};
            
            for (const guest of guests) {
                const roomType = guest.get('roomType') || '未知房型';
                const roomRate = guest.get('roomRate') || 0;
                
                if (!roomTypeRevenue[roomType]) {
                    roomTypeRevenue[roomType] = 0;
                }
                roomTypeRevenue[roomType] += roomRate;
            }
            
            // 转换为ECharts需要的格式
            return Object.entries(roomTypeRevenue).map(([name, value]) => ({
                name,
                value: Math.round(value)
            }));
        }

        /**
         * 获取收入明细记录
         * @param {string} period 时间周期
         * @returns {Array} 收入明细数组
         */
        async function getRevenueRecords(period) {
            const { startDate, endDate } = getDateRange(period);
            
            // 查询订单数据
            const Guest = AV.Object.extend('Guest');
            const query = new AV.Query(Guest);
            query.greaterThanOrEqualTo('checkinTime', startDate);
            query.lessThanOrEqualTo('checkinTime', endDate);
            query.equalTo('status', 'checkin');
            query.descending('checkinTime'); // 按入住时间降序排列
            const guests = await query.find();
            
            // 转换为明细记录格式
            return guests.map(guest => {
                const roomRate = guest.get('roomRate') || 0;
                const deposit = guest.get('deposit') || 0;
                
                return {
                    date: guest.get('checkinTime') || new Date(),
                    roomNumber: guest.get('roomNumber'),
                    roomType: guest.get('roomType'),
                    guestName: guest.get('name'),
                    roomRate,
                    deposit,
                    total: roomRate + deposit
                };
            });
        }

        // ===================== 辅助函数 =====================
        /**
         * 初始化图表实例
         */
        function initCharts() {
            revenueChartInstance = echarts.init(document.getElementById('revenueChart'));
            roomTypeChartInstance = echarts.init(document.getElementById('roomTypeRevenueChart'));
        }

        /**
         * 根据周期获取日期范围
         * @param {string} period 时间周期
         * @returns {Object} 包含startDate和endDate的对象
         */
        function getDateRange(period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    break;
                    
                case 'week':
                    // 本周（周一到周日）
                    const day = now.getDay() || 7; // 周日为7
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - day + 1);
                    startDate.setHours(0, 0, 0, 0);
                    
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'month':
                    // 本月
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                    
                case 'year':
                    // 本年
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                    
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            }
            
            return { startDate, endDate };
        }

        /**
         * 格式化数字（千分位分隔）
         * @param {number} num 要格式化的数字
         * @param {number} decimal 小数位数，默认2
         * @returns {string} 格式化后的字符串
         */
        function formatNumber(num, decimal = 2) {
            if (isNaN(num)) return '0';
            return Number(num).toFixed(decimal).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        /**
         * 格式化日期
         * @param {Date} date 日期对象
         * @param {string} format 格式，默认YYYY-MM-DD
         * @returns {string} 格式化后的日期字符串
         */
        function formatDate(date, format = 'YYYY-MM-DD') {
            if (!(date instanceof Date)) date = new Date(date);
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return format.replace('YYYY', year)
                         .replace('MM', month)
                         .replace('DD', day);
        }

        /**
         * 更新当前时间显示
         */
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }

        /**
         * 切换侧边栏显示/隐藏（移动端）
         */
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        /**
         * 显示加载状态
         */
        function showLoadingState() {
            // 图表加载状态
            document.getElementById('revenueChart').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>加载中...</span>
                </div>
            `;
            document.getElementById('roomTypeRevenueChart').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>加载中...</span>
                </div>
            `;
            
            // 表格加载状态
            document.getElementById('revenueTable').innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>加载中...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            // 重置统计卡片
            document.getElementById('roomRevenue').textContent = '¥0';
            document.getElementById('depositTotal').textContent = '¥0';
            document.getElementById('totalOrders').textContent = '0';
            document.getElementById('avgRoomRate').textContent = '¥0';
        }

        /**
         * 显示成功提示
         * @param {string} message 提示信息
         */
        function showSuccessNotification(message) {
            // 创建临时提示元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3秒后移除
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        /**
         * 显示错误提示
         * @param {string} message 提示信息
         */
        function showErrorNotification(message) {
            // 创建临时提示元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3秒后移除
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
